name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security-check:
    runs-on: ubuntu-latest

    env:
      DB_URL: ${{ 'jdbc:postgresql://localhost:5432/test' }}
      DB_USERNAME: ${{ 'test' }}
      DB_PASSWORD: ${{ 'test' }}
      JWT_SECRET: ${{ 'test' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Run spotbugs check
        run: mvn spotbugs:check

      - name: Run spotbugs spotbugs
        run: mvn spotbugs:spotbugs
        continue-on-error: true

      - name: Upload spotbugs report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: spotbugs-report
          path: |
            target/spotbugs.html
            target/spotbugsXml.xml
            target/site/spotbugs.html

      - name: Run OWASP dependency check
        env:
          NVD_API_KEY: ${{ secrets.API_KEY }}
        run: mvn org.owasp:dependency-check-maven:check -DnvdApiKey=${{ secrets.API_KEY }}
        continue-on-error: true

      - name: Upload OWASP reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: owasp-dependency-check-reports
          path: |
            target/dependency-check-report.html
            target/dependency-check-report.json
            target/dependency-check-report.xml
            target/dependency-check-report.csv

  publish-reports:
    runs-on: ubuntu-latest
    needs: security-check
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Prepare unique folder
        id: prepare
        run: |
          UNIQUE_DIR="run-${{ github.run_id }}"
          mkdir -p "public/${UNIQUE_DIR}"
          mv reports/* "public/${UNIQUE_DIR}"
          echo "unique_dir=${UNIQUE_DIR}" >> $GITHUB_OUTPUT

      - name: Deploy reports to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.TOKEN_GITHUB }}
          publish_dir: public
          keep_files: true

      - name: Add summary with report links
        run: |
          UNIQUE_DIR=${{ steps.prepare.outputs.unique_dir }}
          REPO=${{ github.repository }}
          PAGE_URL="https://${REPO%%/*}.github.io/${REPO#*/}/${UNIQUE_DIR}"

          echo "### Security Reports for run \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SpotBugs reports:**" >> $GITHUB_STEP_SUMMARY
          echo "- [spotbugs.html](${PAGE_URL}/spotbugs-report/site/spotbugs.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [spotbugsXml.xml](${PAGE_URL}/spotbugs-report/spotbugsXml.xml)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**OWASP Dependency Check reports:**" >> $GITHUB_STEP_SUMMARY
          echo "- [dependency-check-report.html](${PAGE_URL}/owasp-dependency-check-reports/dependency-check-report.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [dependency-check-report.json](${PAGE_URL}/owasp-dependency-check-reports/dependency-check-report.json)" >> $GITHUB_STEP_SUMMARY
          echo "- [dependency-check-report.xml](${PAGE_URL}/owasp-dependency-check-reports/dependency-check-report.xml)" >> $GITHUB_STEP_SUMMARY
          echo "- [dependency-check-report.csv](${PAGE_URL}/owasp-dependency-check-reports/dependency-check-report.csv)" >> $GITHUB_STEP_SUMMARY
